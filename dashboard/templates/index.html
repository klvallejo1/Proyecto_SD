# ./dashboard/templates/index.html
<!DOCTYPE html>
<html>
<head>
    <title>Dashboard de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Dashboard de Pedidos</h1>
        
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-primary" onclick="cargarPedidos(document.getElementById('sucursal').value)">
                    Actualizar Datos
                </button>
                <small class="text-muted ms-2">Actualización automática cada 5 segundos</small>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <label for="sucursal" class="form-label">Filtrar por Sucursal:</label>
                <select class="form-select" id="sucursal">
                    <option value="">Todas las sucursales</option>
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Sucursal</th>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Total</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="pedidos-table">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let ultimaActualizacion = 0;
        const INTERVALO_MINIMO = 1000; // 1 segundo entre actualizaciones

        async function cargarPedidos(sucursal = '') {
            const ahora = Date.now();
            if (ahora - ultimaActualizacion < INTERVALO_MINIMO) {
                return; // Evitar actualizaciones muy frecuentes
            }
            ultimaActualizacion = ahora;

            try {
                let url = '/pedidos';
                if (sucursal) {
                    url = `/pedidos/sucursal/${encodeURIComponent(sucursal)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const pedidos = await response.json();
                actualizarTablaPedidos(pedidos);
                actualizarSucursales(pedidos);
            } catch (error) {
                console.error('Error al cargar los pedidos:', error);
                mostrarError(error.message);
            }
        }

        function actualizarTablaPedidos(pedidos) {
            const tbody = document.getElementById('pedidos-table');
            
            if (!pedidos || pedidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay pedidos disponibles</td></tr>';
                return;
            }

            // Crear un fragmento para mejor rendimiento
            const fragment = document.createDocumentFragment();
            pedidos.forEach(pedido => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pedido.id}</td>
                    <td>${pedido.sucursal}</td>
                    <td>${pedido.producto}</td>
                    <td>${pedido.cantidad}</td>
                    <td>$${parseFloat(pedido.total).toFixed(2)}</td>
                    <td>${new Date(pedido.fecha).toLocaleString()}</td>
                `;
                fragment.appendChild(row);
            });

            // Actualizar la tabla una sola vez
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function actualizarSucursales(pedidos) {
            if (!pedidos || pedidos.length === 0) return;

            const sucursales = new Set(pedidos.map(p => p.sucursal));
            const selector = document.getElementById('sucursal');
            const valorActual = selector.value;
            
            const fragment = document.createDocumentFragment();
            const optionTodas = document.createElement('option');
            optionTodas.value = '';
            optionTodas.textContent = 'Todas las sucursales';
            fragment.appendChild(optionTodas);

            sucursales.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                if (s === valorActual) option.selected = true;
                fragment.appendChild(option);
            });

            selector.innerHTML = '';
            selector.appendChild(fragment);
        }

        function mostrarError(mensaje) {
            const tbody = document.getElementById('pedidos-table');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        Error al cargar los datos: ${mensaje}
                    </td>
                </tr>
            `;
        }

        // Event listener para el selector de sucursales
        document.getElementById('sucursal').addEventListener('change', (e) => {
            cargarPedidos(e.target.value);
        });

        // Cargar datos iniciales
        cargarPedidos();

        // Actualizar datos cada 5 segundos
        const intervaloActualizacion = 5000; // 5 segundos
        setInterval(() => {
            const sucursal = document.getElementById('sucursal').value;
            cargarPedidos(sucursal);
        }, intervaloActualizacion);

        // Intentar actualizar inmediatamente después de un nuevo pedido
        let intentosInmediatos = 0;
        const maximoIntentos = 6; // Intentar durante 3 segundos (6 intentos * 500ms)

        function actualizacionInmediata() {
            if (intentosInmediatos < maximoIntentos) {
                setTimeout(() => {
                    cargarPedidos(document.getElementById('sucursal').value);
                    intentosInmediatos++;
                    actualizacionInmediata();
                }, 500);
            }
        }

        // Escuchar por nuevos pedidos (opcional, si implementas websockets)
        window.addEventListener('nuevoPedido', () => {
            intentosInmediatos = 0;
            actualizacionInmediata();
        });
    </script>
</body>
</html>